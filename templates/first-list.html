{% extends 'base.html' %}
{% block title %}
List page
{% endblock %}

{% block content %}
<style>
    /* ... Your existing styles ... */
</style>
<div class="container">
    <form id="item-form">
        <table class="table table-bordered table-dark">
            <thead>
                <tr>
                    <th>item</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                <tr class="data-row">
                    <td><input class="data-input" type="text" name="item" placeholder="item"></td>
                    <td><input class="data-input" type="text" name="quantity" placeholder="quantity"></td>
                    <td><div class="mark-square"></div></td>
                </tr>
            </tbody>
        </table>
    </form>

    <!-- Finish Button -->
    <button class="finish-button">FINISH !</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const container = document.querySelector(".container");
        const form = document.getElementById("item-form");
        const finishButton = document.querySelector(".finish-button");

        container.addEventListener("keydown", function (event) {
            if (event.key === "Enter" && event.target.classList.contains("data-input")) {
                event.preventDefault(); // Prevent the default behavior (form submission)
                const newRow = createEmptyRow();
                const currentRow = event.target.closest(".data-row");
                const nextRow = currentRow.nextElementSibling;

                if (nextRow) {
                    nextRow.before(newRow);
                } else {
                    currentRow.parentNode.appendChild(newRow);
                }

                newRow.querySelector(".data-input").focus();
            }
        });

        finishButton.addEventListener("click", function () {
            const user = "{{ user.username }}";  // Get the username from the template context
            const dataRows = document.querySelectorAll(".data-row");
            const formData = [];

            dataRows.forEach(row => {
                const item = row.querySelector("input[name='item']").value;
                const quantity = row.querySelector("input[name='quantity']").value;

                if (item && quantity) {
                    formData.push({ item, quantity });
                }
            });

            // Send the data to the server
            fetch("/save-items", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    user: user,
                    items: formData
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);  // Handle the response from the server if needed
            })
            .catch(error => {
                console.error("Error:", error);
            });
        });

        function createEmptyRow() {
            const newRow = document.createElement("tr");
            newRow.classList.add("data-row");
            newRow.innerHTML = `
                <td><input class="data-input" type="text" name="item"></td>
                <td><input class="data-input" type="text" name="quantity"></td>
                <td><div class="mark-square"></div></td>
            `;
            return newRow;
        }
    });
</script>
{% endblock %}
